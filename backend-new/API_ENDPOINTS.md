# REST API Endpoints - UI Mapping

## 1. GET /api/risk-monitor
**UI Panel:** Risk Monitor (includes ALL market data + watchlist)

**Returns:**
```json
{
  "risk_level": {
    "score": 73,
    "level": "HIGH",
    "summary": "Major divergence detected. Prediction markets showing conflicting signals..."
  },
  "market_overview": {
    "btc_price": 98742.31,
    "price_change_24h": 0.92,
    "volume_24h": "$42.1B",
    "price_range_24h": {
      "low": 97800.00,
      "high": 99200.00
    }
  },
  "technical": {
    "rsi": 67.8,
    "macd": 245
  },
  "watchlist": [
    {"ticker": "ETH/USD", "change": "+2.4%"},
    {"ticker": "SOL/USD", "change": "-1.2%"},
    {"ticker": "AVAX/USD", "change": "+5.8%"},
    {"ticker": "MATIC/USD", "change": "-0.8%"}
  ]
}
```

**Queries:**
```sql
-- Market Context
SELECT * FROM market_context ORDER BY created_at DESC LIMIT 1;

-- Watchlist
SELECT ticker, price_change_24h FROM watchlist ORDER BY ticker;
```

**Notes:**
- `risk_score` calculated by Monitor Worker (1s) using weighted formula
- `summary` generated by Data Ingest Worker (10s) using LLM
- `level` derived from score: <40=LOW, 40-70=MEDIUM, >70=HIGH
- RSI/MACD can be hardcoded or calculated (optional for MVP)
- Watchlist updated by Data Ingest Worker every 10s
- All other data written by Data Ingest Worker every 10s

---

## 2. GET /api/portfolio
**UI Panel:** Portfolio tab

**Now reads from:** Alpaca account + Supabase lock state

**Returns:**
```json
{
  "balance_usd": 49200.10,
  "total_value": 50542.33,
  "pnl_total": 210.45,
  "pnl_percent": 0.42,
  "is_locked": false,
  "lock_reason": null,
  "lock_expires_at": null
}
```

- `balance_usd` comes from Alpaca `cash`
- `total_value` = Alpaca `portfolio_value`
- `pnl_total/pnl_percent` derived from Alpaca `equity` vs `last_equity`
- `is_locked` still comes from Supabase `portfolio` table (agent lock switch)

---

## 3. GET /api/positions
**UI Panel:** Portfolio → Open Positions

**Data source:** `trading_service.get_positions()` (Alpaca)

**Returns:**
```json
[
  {
    "id": "BTCUSD",
    "ticker": "BTC/USD",
    "side": "LONG",
    "amount": 0.5,
    "entry_price": 96250.00,
    "current_price": 98742.31,
    "pnl": 1246.15,
    "pnl_percent": 2.59
  }
]
```

- P&L recalculated with live prices from Alpaca’s streaming cache
- `id` = Alpaca symbol (e.g., `BTCUSD`) to keep frontend stable

---

## 4. GET /api/orders
**UI Panel:** Portfolio → Open Orders

**Data source:** `trading_service.get_orders(status="open")`

**Returns Alpaca orders** with simplified fields:
```json
[
  {
    "id": "d7d...f8",
    "ticker": "BTC/USD",
    "order_type": "LIMIT BUY",
    "amount": 0.3,
    "limit_price": 97500.00,
    "created_at": "2024-01-15T09:00:00Z",
    "status": "open",
    "placed_ago": ""
  }
]
```

---

## 5. DELETE /api/orders/:id
Cancels the Alpaca order via `trading_service.cancel_order(order_id)`.

---

## 5b. PATCH /api/positions/:symbol
**Purpose:** Adjust position size by submitting offsetting market orders.

**Body:**
```json
{ "amount": 0.3 }
```

- Fetches current Alpaca position
- Calculates delta vs requested size
- Places buy/sell market order for the difference

---

## 5c. POST /api/positions/:symbol/close
Calls `trading_service.close_position(symbol, qty)` which routes to Alpaca `close_position`. `qty` is optional (default close entire position).

---

## 6. GET /api/history
**UI Panel:** Trade History tab

- Fetches Alpaca orders with `status="closed"`
- Filters to filled orders and returns simplified entries (pnl currently 0 until we add deeper analytics)

---

## 7. POST /api/orders
**UI Action:** Trading tab manual order

- Routes to Alpaca:
  - `order_type="MARKET"` → `place_market_order`
  - `"LIMIT"` → `place_limit_order`
  - `"STOP_LOSS"` → `place_stop_order` using `limit_price` as stop trigger
- Returns Alpaca’s order payload directly (plus normalized ticker)

---

## 8. GET /api/polymarket
**UI Panel:** Prediction Markets

**Returns:**
```json
[
  {
    "question": "Bitcoin > $100k by Dec 31",
    "probability": 68,
    "change": "+12%",
    "volume": "2.4M",
    "url": "https://polymarket.com/event/bitcoin-above-100k-by-dec-31"
  }
]
```

**Query:**
```sql
SELECT title, metadata
FROM feed_items
WHERE source = 'POLYMARKET'
ORDER BY created_at DESC
LIMIT 10;
```

**Metadata structure:**
```json
{
  "odds": 0.68,
  "volume": "2.4M",
  "change": "+12%",
  "url": "https://polymarket.com/event/..."
}
```

**Notes:** EVERY Polymarket item MUST have a URL field in metadata

---

## 9. GET /api/reddit?subreddit={filter}
**UI Panel:** Social Sentiment → Individual posts

**Query Parameters:**
- `subreddit` (optional): Filter by subreddit
  - `All` (default) - Returns all posts
  - `r/wallstreetbets` - Returns only posts from that subreddit
  - `r/Polymarket` - Returns only posts from that subreddit
  - etc.

**Returns:**
```json
[
  {
    "text": "Election odds flipped after overnight whale order...",
    "username": "u/polymarketnerd",
    "subreddit": "r/Polymarket",
    "sentiment": "bullish",
    "posted_ago": "3m",
    "url": "https://reddit.com/r/Polymarket/comments/abc123/"
  }
]
```

**Query:**
```sql
-- If subreddit = 'All' or not provided
SELECT title, metadata
FROM feed_items
WHERE source = 'REDDIT'
ORDER BY created_at DESC
LIMIT 50;

-- If specific subreddit provided
SELECT title, metadata
FROM feed_items
WHERE source = 'REDDIT'
  AND metadata->>'subreddit' = 'r/wallstreetbets'
ORDER BY created_at DESC
LIMIT 50;
```

**Metadata structure:**
```json
{
  "username": "u/polymarketnerd",
  "subreddit": "r/Polymarket",
  "sentiment": "bullish",
  "posted_ago": "3m",
  "url": "https://reddit.com/r/Polymarket/comments/..."
}
```

**Notes:**
- Returns ~50 most recent posts from latest data fetch
- EVERY Reddit post MUST have a URL field in metadata
- Frontend displays these as clickable cards
- Filter by subreddit using JSONB query on metadata

---

## 10. GET /api/sentiment
**UI Panel:** Social Sentiment → Aggregated stats (top section)

**Returns:**
```json
{
  "bullish": 61,
  "bearish": 40,
  "score": 21,
  "volume": "15.1k"
}
```

**Query:**
```sql
SELECT sentiment_bullish, sentiment_bearish, sentiment_score, post_volume_24h
FROM market_context
ORDER BY created_at DESC
LIMIT 1;
```

**Notes:**
- This is PROCESSED/aggregated data from market_context
- Separate from individual Reddit posts (GET /api/reddit)
- Data Ingest Worker calculates these stats from all ~50 fetched posts

---

## Summary

**5 Tables:**
1. `portfolio` - User balance & lock state
2. `trades` - Orders, positions, history
3. `market_context` - Aggregated stats (for agent + risk score calculation)
4. `feed_items` - Individual posts/markets (for UI display)
5. `watchlist` - Altcoin prices (ETH, SOL, AVAX, MATIC)

**10 Endpoints:**
- 4 for portfolio/positions/orders/history
- 3 for market data (risk-monitor, polymarket, reddit)
- 1 for sentiment stats (aggregated)
- 2 for trading (create order, cancel order)

**What WE Calculate (Not External APIs):**
- `risk_score` - **Monitor Worker** calculates using weighted formula (sentiment + technical + polymarket)
- `summary` - **Data Ingest Worker** generates with LLM
- `sentiment_score` - **Data Ingest Worker** calculates from bullish/bearish post counts
- `sentiment_bullish/bearish` - **Data Ingest Worker** counts from Reddit posts
- RSI/MACD - Optional, can be calculated or hardcoded

**Key Data Flow:**
1. **Data Ingest Worker (every 10s)** fetches and processes:
   - ~50 Reddit posts + ~10 Polymarket markets → `feed_items` (with URLs!)
   - BTC price data + LLM analysis → `market_context` (sentiment, price, summary, BUT risk_score=0)
   - Watchlist prices (ETH, SOL, AVAX, MATIC) → `watchlist`

2. **Monitor Worker (every 1s)** calculates:
   - Reads latest `market_context`
   - Calculates `risk_score` using weighted formula
   - Updates `risk_score` in `market_context`
   - If risk_score > 80 → Sends INTERRUPT

3. **Frontend** calls REST API:
   - `GET /api/risk-monitor` → Full Risk Monitor data (market_context + watchlist)
   - `GET /api/reddit?subreddit=All` → Individual posts from `feed_items`
   - `GET /api/sentiment` → Aggregated stats from `market_context`
   - `GET /api/polymarket` → Individual markets from `feed_items`

All UI panels covered! ✅
