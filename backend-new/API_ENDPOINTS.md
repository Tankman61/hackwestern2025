# REST API Endpoints - UI Mapping

## 1. GET /api/risk-monitor
**UI Panel:** Risk Monitor (includes ALL market data + watchlist)

**Returns:**
```json
{
  "risk_level": {
    "score": 73,
    "level": "HIGH",
    "summary": "Major divergence detected. Prediction markets showing conflicting signals..."
  },
  "market_overview": {
    "btc_price": 98742.31,
    "price_change_24h": 0.92,
    "volume_24h": "$42.1B",
    "price_range_24h": {
      "low": 97800.00,
      "high": 99200.00
    }
  },
  "technical": {
    "rsi": 67.8,
    "macd": 245
  },
  "watchlist": [
    {"ticker": "ETH/USD", "change": "+2.4%"},
    {"ticker": "SOL/USD", "change": "-1.2%"},
    {"ticker": "AVAX/USD", "change": "+5.8%"},
    {"ticker": "MATIC/USD", "change": "-0.8%"}
  ]
}
```

**Queries:**
```sql
-- Market Context
SELECT * FROM market_context ORDER BY created_at DESC LIMIT 1;

-- Watchlist
SELECT ticker, price_change_24h FROM watchlist ORDER BY ticker;
```

**Notes:**
- `risk_score` calculated by Monitor Worker (1s) using weighted formula
- `summary` generated by Data Ingest Worker (10s) using LLM
- `level` derived from score: <40=LOW, 40-70=MEDIUM, >70=HIGH
- RSI/MACD can be hardcoded or calculated (optional for MVP)
- Watchlist updated by Data Ingest Worker every 10s
- All other data written by Data Ingest Worker every 10s

---

## 2. GET /api/portfolio
**UI Panel:** Portfolio tab

**Returns:**
```json
{
  "balance_usd": 50000.00,
  "total_value": 142847.23, // Calculated: balance + open positions value
  "pnl_total": 8492.15,
  "pnl_percent": 6.32,
  "is_locked": false
}
```

**Query:**
```sql
SELECT * FROM portfolio LIMIT 1;
-- Calculate total_value by summing open positions at current prices
```

---

## 3. GET /api/positions
**UI Panel:** Portfolio → Open Positions

**Returns:**
```json
[
  {
    "id": "uuid",
    "ticker": "BTC/USD",
    "side": "LONG",
    "amount": 0.5,
    "entry_price": 96250.00,
    "current_price": 98742.31,
    "pnl": 1246.15,
    "pnl_percent": 2.59
  },
  {
    "id": "uuid",
    "ticker": "ETH/USD",
    "side": "SHORT",
    "amount": 2.0,
    "entry_price": 3842.00,
    "current_price": 3934.25,
    "pnl": -184.50,
    "pnl_percent": -2.40
  }
]
```

**Query:**
```sql
SELECT * FROM trades
WHERE status = 'OPEN' AND entry_price IS NOT NULL
ORDER BY created_at DESC;
```

**Notes:**
- Frontend calculates `current_price` by fetching latest BTC/ETH prices
- `pnl` = (current_price - entry_price) * amount * (1 if LONG else -1)

---

## 4. GET /api/orders
**UI Panel:** Portfolio → Open Orders

**Returns:**
```json
[
  {
    "id": "uuid",
    "ticker": "BTC/USD",
    "order_type": "LIMIT BUY",
    "amount": 0.3,
    "limit_price": 97500.00,
    "created_at": "2024-01-15T09:00:00Z",
    "placed_ago": "30 min ago"
  }
]
```

**Query:**
```sql
SELECT * FROM trades
WHERE status = 'OPEN' AND entry_price IS NULL
ORDER BY created_at DESC;
```

**Notes:** Orders have `limit_price` but no `entry_price` yet

---

## 5. DELETE /api/orders/:id
**UI Action:** Cancel Order button

**Body:** None

**Action:** `UPDATE trades SET status = 'CANCELLED' WHERE id = :id`

---

## 5b. PATCH /api/positions/:id
**UI Action:** Adjust position size button

**Body:**
```json
{
  "amount": 0.3
}
```

**Action:**
```sql
UPDATE trades
SET amount = :amount
WHERE id = :id AND status = 'OPEN' AND entry_price IS NOT NULL;
```

**Returns:** Updated position object

**Notes:** Can only adjust open positions, not pending orders

---

## 5c. POST /api/positions/:id/close
**UI Action:** Close position button

**Body:**
```json
{
  "current_price": 98742.31
}
```

**Action:**
```sql
-- 1. Calculate P&L
--    For LONG: pnl = (current_price - entry_price) * amount
--    For SHORT: pnl = (entry_price - current_price) * amount

-- 2. Update trade
UPDATE trades
SET status = 'FILLED',
    exit_price = :current_price,
    pnl = :calculated_pnl,
    filled_at = NOW()
WHERE id = :id AND status = 'OPEN';

-- 3. Update portfolio balance
UPDATE portfolio
SET balance_usd = balance_usd + :calculated_pnl;
```

**Returns:** Closed position object with final P&L

**Notes:** Automatically updates portfolio balance with profit/loss

---

## 6. GET /api/history
**UI Panel:** Trade History tab

**Returns:**
```json
[
  {
    "id": "uuid",
    "ticker": "BTC/USD",
    "side": "LONG",
    "amount": 0.6,
    "entry_price": 94200.00,
    "exit_price": 98900.00,
    "pnl": 2847.00,
    "filled_at": "2024-01-15T08:00:00Z",
    "time_ago": "2 hours ago"
  }
]
```

**Query:**
```sql
SELECT * FROM trades
WHERE status = 'FILLED'
ORDER BY filled_at DESC
LIMIT 50;
```

---

## 7. POST /api/orders
**UI Action:** Manual trade execution (Trading tab)

**Body:**
```json
{
  "ticker": "BTC-USD",
  "side": "BUY",
  "order_type": "LIMIT",
  "amount": 0.5,
  "limit_price": 97500.00
}
```

**Action:**
```sql
INSERT INTO trades (ticker, side, order_type, amount, limit_price, status)
VALUES (:ticker, :side, :order_type, :amount, :limit_price, 'OPEN');
```

**Returns:** Created trade object

---

## 8. GET /api/polymarket
**UI Panel:** Prediction Markets

**Returns:**
```json
[
  {
    "question": "Bitcoin > $100k by Dec 31",
    "probability": 68,
    "change": "+12%",
    "volume": "2.4M",
    "url": "https://polymarket.com/event/bitcoin-above-100k-by-dec-31"
  }
]
```

**Query:**
```sql
SELECT title, metadata
FROM feed_items
WHERE source = 'POLYMARKET'
ORDER BY created_at DESC
LIMIT 10;
```

**Metadata structure:**
```json
{
  "odds": 0.68,
  "volume": "2.4M",
  "change": "+12%",
  "url": "https://polymarket.com/event/..."
}
```

**Notes:** EVERY Polymarket item MUST have a URL field in metadata

---

## 9. GET /api/reddit?subreddit={filter}
**UI Panel:** Social Sentiment → Individual posts

**Query Parameters:**
- `subreddit` (optional): Filter by subreddit
  - `All` (default) - Returns all posts
  - `r/wallstreetbets` - Returns only posts from that subreddit
  - `r/Polymarket` - Returns only posts from that subreddit
  - etc.

**Returns:**
```json
[
  {
    "text": "Election odds flipped after overnight whale order...",
    "username": "u/polymarketnerd",
    "subreddit": "r/Polymarket",
    "sentiment": "bullish",
    "posted_ago": "3m",
    "url": "https://reddit.com/r/Polymarket/comments/abc123/"
  }
]
```

**Query:**
```sql
-- If subreddit = 'All' or not provided
SELECT title, metadata
FROM feed_items
WHERE source = 'REDDIT'
ORDER BY created_at DESC
LIMIT 50;

-- If specific subreddit provided
SELECT title, metadata
FROM feed_items
WHERE source = 'REDDIT'
  AND metadata->>'subreddit' = 'r/wallstreetbets'
ORDER BY created_at DESC
LIMIT 50;
```

**Metadata structure:**
```json
{
  "username": "u/polymarketnerd",
  "subreddit": "r/Polymarket",
  "sentiment": "bullish",
  "posted_ago": "3m",
  "url": "https://reddit.com/r/Polymarket/comments/..."
}
```

**Notes:**
- Returns ~50 most recent posts from latest data fetch
- EVERY Reddit post MUST have a URL field in metadata
- Frontend displays these as clickable cards
- Filter by subreddit using JSONB query on metadata

---

## 10. GET /api/sentiment
**UI Panel:** Social Sentiment → Aggregated stats (top section)

**Returns:**
```json
{
  "bullish": 61,
  "bearish": 40,
  "score": 21,
  "volume": "15.1k"
}
```

**Query:**
```sql
SELECT sentiment_bullish, sentiment_bearish, sentiment_score, post_volume_24h
FROM market_context
ORDER BY created_at DESC
LIMIT 1;
```

**Notes:**
- This is PROCESSED/aggregated data from market_context
- Separate from individual Reddit posts (GET /api/reddit)
- Data Ingest Worker calculates these stats from all ~50 fetched posts

---

## Summary

**5 Tables:**
1. `portfolio` - User balance & lock state
2. `trades` - Orders, positions, history
3. `market_context` - Aggregated stats (for agent + risk score calculation)
4. `feed_items` - Individual posts/markets (for UI display)
5. `watchlist` - Altcoin prices (ETH, SOL, AVAX, MATIC)

**10 Endpoints:**
- 4 for portfolio/positions/orders/history
- 3 for market data (risk-monitor, polymarket, reddit)
- 1 for sentiment stats (aggregated)
- 2 for trading (create order, cancel order)

**What WE Calculate (Not External APIs):**
- `risk_score` - **Monitor Worker** calculates using weighted formula (sentiment + technical + polymarket)
- `summary` - **Data Ingest Worker** generates with LLM
- `sentiment_score` - **Data Ingest Worker** calculates from bullish/bearish post counts
- `sentiment_bullish/bearish` - **Data Ingest Worker** counts from Reddit posts
- RSI/MACD - Optional, can be calculated or hardcoded

**Key Data Flow:**
1. **Data Ingest Worker (every 10s)** fetches and processes:
   - ~50 Reddit posts + ~10 Polymarket markets → `feed_items` (with URLs!)
   - BTC price data + LLM analysis → `market_context` (sentiment, price, summary, BUT risk_score=0)
   - Watchlist prices (ETH, SOL, AVAX, MATIC) → `watchlist`

2. **Monitor Worker (every 1s)** calculates:
   - Reads latest `market_context`
   - Calculates `risk_score` using weighted formula
   - Updates `risk_score` in `market_context`
   - If risk_score > 80 → Sends INTERRUPT

3. **Frontend** calls REST API:
   - `GET /api/risk-monitor` → Full Risk Monitor data (market_context + watchlist)
   - `GET /api/reddit?subreddit=All` → Individual posts from `feed_items`
   - `GET /api/sentiment` → Aggregated stats from `market_context`
   - `GET /api/polymarket` → Individual markets from `feed_items`

All UI panels covered! ✅
